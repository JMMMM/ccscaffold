# Research: Continuous Learning Refactor

**Feature**: 1-continuous-learning
**Date**: 2026-02-09

## Decision: 问题检测算法

**选择**: 使用关键词频率统计 + 相似度匹配检测反复问题

**理由**:
1. **实现简单**: 关键词统计使用 Python 标准库即可实现
2. **性能充足**: 对于 20 条对话，计算复杂度可忽略
3. **准确度高**: 关键词 + 相似度组合能识别大部分反复问题
4. **无外部依赖**: 不需要 NLP 模型或第三方库

**替代方案评估**:

| 方案 | 优点 | 缺点 | 结论 |
|------|------|------|------|
| 关键词频率 + 相似度 | 简单、无依赖、够用 | 可能遗漏语义相似但关键词不同的问题 | ✅ 采纳 |
| NLP 语义分析 | 准确度高 | 需要额外依赖、复杂度高 | ❌ 拒绝 |
| 简单字符串匹配 | 最简单 | 无法识别不同表述的同一问题 | ❌ 拒绝 |

## 对话文件格式验证

**文件路径**: `.claude/conversations/conversation.txt`

**格式分析**:
```
时间戳 sender> content
```

**示例**:
```
2026-02-09 20:49:40 claude> Tool: Read
  Input: {"file_path": "/path/to/project/..."}

2026-02-09 20:56:11 user> 测试修复后的记录
```

**解析规则**:
1. 时间戳格式: `YYYY-MM-DD HH:MM:SS`
2. sender 可以是: `user`, `claude`, `assistant`
3. 内容可能跨多行，缩进表示内容延续
4. 工具调用格式: `sender> Tool: ToolName`

## 测试数据分析

**数据来源**: `/path/to/source/.claude/conversations/conversation.txt`

**问题模式识别**:

### 模式 1: 数据日历周末显示问题

**检测到的问题**:
- 用户反复提到周末显示红色的问题
- 具体日期: 2月1日（星期日）、2月7日、2月8日（星期六）
- 用户明确表示"问题没有得到解决"
- 沟通次数: ≥3次

**关键词**:
- "周末"、"星期日"、"星期六"
- "显示红色"
- "交易日"
- "数据日历"

**对话片段**:
```
2026-02-09 20:59:52 user> 数据日历中，应该仅判断交易日任务是否完成，
但我发现2月1日（星期日），2月7日，2月8日（星期六）都显示了红色，
帮我分析一下原因并修复问题

...

2026-02-09 21:12:02 user> - 2月1日（星期日）显示红色
  - 2月7日显示红色
  - 2月8日（星期六）显示红色 问题没有得到解决
```

**预期生成的技能**:
- 问题概述: 数据日历在非交易日（周末）错误地显示任务状态
- 根本原因: 交易日判断逻辑默认值错误（默认为交易日而非非交易日）
- 解决方案: 修改默认值为 False，只在明确标记为交易日时才检查任务
- 预防措施: 使用明确的默认值，避免模糊逻辑

### 模式 2: 板块追踪排序功能（完整开发流程）

这个案例展示了完整的功能开发过程，从需求分析到实现完成，不是反复出现的问题。

## Claude API 集成方案

**调用方式**: 通过 `subprocess` 调用 `claude` 命令行工具

**命令格式**:
```bash
echo "PROMPT" | claude -p
```

**Prompt 模板**:
```python
PROMPT_TEMPLATE = """
# 角色设定
你是一个具备持续学习能力的 AI 助手。

# 任务
分析以下对话内容，找出多次沟通（≥ {retry_threshold} 次）都没有解决的问题，
并生成一个学习技能。

# 对话内容
{conversation_content}

# 要求
1. 生成 markdown 格式的技能文件
2. 包含：问题概述、触发点识别、解决方案、使用建议
3. 如果存在相似技能，说明如何更新扩展
"""
```

**响应解析**:
- 提取生成的 markdown 内容
- 验证格式正确性
- 保存到指定目录

## 状态跟踪设计

**状态文件**: `.claude/skills/continuous-learning/state.json`

**数据结构**:
```json
{
  "conversation_file_name": {
    "last_line": 150,
    "skills_generated": [
      {
        "name": "fix-weekend-display-issue",
        "generated_at": "2026-02-09T21:30:00",
        "processed_line": 150
      }
    ],
    "first_analyzed": "2026-02-09T21:00:00",
    "last_analyzed": "2026-02-09T21:30:00"
  }
}
```

**跟踪策略**:
1. 记录已处理的行数
2. 下次分析时从该行继续
3. 避免重复生成相同技能

## 性能分析

**数据规模**:
- 对话条数: 20 条（可配置）
- 平均每条长度: ~500 字符
- 总数据量: ~10 KB

**性能预估**:
- 文件读取: < 10ms
- 问题分析: < 100ms
- Claude API 调用: ~5-10s
- 文件写入: < 10ms
- **总计: < 15s**（远低于 60s 目标）

## 集成点分析

### SessionEnd 钩子集成

**触发时机**: 会话结束时（Stop 事件）

**执行流程**:
1. 检查事件类型是否为 `Stop`
2. 调用 `summary_skills.py` 脚本
3. 使用 `--mode auto` 参数
4. 超时保护: 60 秒

**配置位置**:
```json
{
  "hooks": {
    "SessionEnd": [
      {
        "script": ".claude/skills/continuous-learning/scripts/session_end_hook.py",
        "description": "持续学习: 自动分析对话并生成技能"
      }
    ]
  }
}
```

### 命令集成

**命令名称**: `/summary-skills`

**触发方式**: 用户在对话中输入命令

**执行流程**:
1. 读取当前会话的 conversation.txt
2. 从上次处理的行继续
3. 显示分析结果
4. 等待用户确认（交互模式）

**配置文件**: `.claude/commands/summary-skills.md`
